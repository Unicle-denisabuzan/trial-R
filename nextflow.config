k8s {
   context='gke_uniapp-cromwell_europe-west2-b_cluster-1'
   namespace='default'
   workDir='/workspace/example_nf/example_nf/work'
   storageClaimName = 'test-dynamic-volume-claim'
   computeResourceType = 'job'
}

executor {
  queueSize = 30
}


process {
   executor='k8s'
   container = 'eu.gcr.io/uniapp-cromwell/biomex.dimension.reduction@sha256:c2df0af02ba0f71c795eccc96cd5287146f133db1fb9dfadb05e9d9224bfb074'

   withLabel:gpu {
        container = (params.similarity_hardware_type == "cpu")
            ? "systemsgenetics/kinc:3.4.2-cpu"
            : "systemsgenetics/kinc:3.4.2-gpu"

        if ( params.similarity_hardware_type != "cpu" ) {
            accelerator = 1
        }
    }
}


profiles {
    docker {
        docker.enabled = true
    }

    google {
        process {
            executor = "google-lifesciences"
            maxRetries = 10

            cpus = 2
            memory = 8.GB

            withLabel:gpu {
                if ( params.similarity_hardware_type != "cpu" ) {
                    accelerator = [request: 1, type: params.similarity_hardware_type]
                }
            }
        }
        executor {
            queueSize = (params.similarity_hardware_type == "cpu") ? 50 : 1
        }
        google {
            zone = "us-central1-c"

            lifeSciences.bootDiskSize = 20.GB
            lifeSciences.debug = false
            lifeSciences.preemptible = true
            lifeSciences.sshDaemon = false
        }

        workDir = "gs://nextflow-data/work"
    }

    palmetto {
        process {
            executor = "pbspro"
            time = 24.h
            clusterOptions = "-l select=1:mem=14gb:ncpus=2"

            // Due to a Palmetto scheduling bug, ncpus must greater
            // than 1 and interconnect must be specified in order to
            // prevent jobs from landing on a c1 phase.
            withName:similarity_chunk {
                clusterOptions = (params.similarity_hardware_type == "cpu")
                    ? "-l select=1:mem=14gb:ncpus=2:interconnect=fdr"
                    : "-l select=1:mem=14gb:ncpus=${params.similarity_threads}:ngpus=1:gpu_model=${params.similarity_hardware_type}"
            }
            withName:similarity_mpi {
                clusterOptions = (params.similarity_hardware_type == "cpu")
                    ? "-l select=${params.similarity_chunks}:mem=14gb:ncpus=2:interconnect=fdr"
                    : "-l select=${params.similarity_chunks}:mem=14gb:ncpus=${params.similarity_threads}:ngpus=1:gpu_model=${params.similarity_hardware_type}"
            }
            withName:corrpower {
                clusterOptions = "-l select=${params.corrpower_chunks}:mem=8gb:ncpus=2:interconnect=fdr"
            }
            withName:condtest {
                clusterOptions = "-l select=${params.corrpower_chunks}:mem=8gb:ncpus=2:interconnect=fdr"
            }
        }
        executor {
            queueSize = 50
        }
    }

    singularity {
        singularity.enabled = true
    }

    standard {
        process {
            memory = 14.GB

            withName:similarity_chunk {
                cpus = (params.similarity_hardware_type == "cpu")
                    ? 1
                    : params.similarity_threads
            }
            withName:similarity_mpi {
                cpus = (params.similarity_hardware_type == "cpu")
                    ? params.similarity_chunks
                    : params.similarity_chunks * params.similarity_threads
            }
            withName:corrpower {
                cpus = params.corrpower_chunks
            }
            withName:condtest {
                cpus = params.condtest_chunks
            }
        }
    }

    testing {
        process.errorStrategy = "terminate"
    }
}
